<html>
    <head>
        <title>Discrete-Event Simulator: Ant Foraging</title>
        <script src="../src/jssim.js" type="text/javascript"></script>
    </head>
    <body>
        <h2>Discrete-Event Simulator: Ant Foraging <input type="text" id="simTime" value="" /></h2>
        
        <canvas id="myCanvas" width="640" height="640" style="border:1px solid #000000;">
        </canvas>
        
        <script>
            (function(){
                
                var Ant = function(id, grid, x, y) {
                    jssim.SimEvent(this);
                    this.id = id;
                    this.x = x;
                    this.y = y;
                    this.init_x = x;
                    this.init_y = y;
                    this.prev_x = x;
                    this.prev_y = y;
                    this.grid = grid;
                    this.grid.setCell(this.x, this.y, 1);
                };
                
                Ant.prototype.update = function(deltaTime) {
                    var act_x = this.x;
                    var act_y = this.y;
                    
                    for(var dx = -1; dx <= 1; ++dx) {
                        for(var dy = -1; dy <= 1; ++dy) {
                            var _x = this.x + dx;
                            var _y = this.y + dy;
                            if(_x == this.prev_x && _y == this.prev_y) continue;
                            if(_x == this.x && _y == this.y) continue;
                            if(!this.grid.hasPath(_x, _y)) {
                                continue;
                            }
                            if(this.grid.isOccupied(_x, _y)) {
                                continue;
                            }
                            if(this.grid.isTarget(_x, _y)) {
                                this.grid.setCell(this.x, this.y, 0);
                                this.x = this.init_x;
                                this.y = this.init_y;
                                this.prev_x = this.x;
                                this.prev_y = this.y;
                                this.grid.setCell(this.x, this.y, 1);
                                console.log(this.id + ' reach target!');
                                return;
                            }
                            act_x = _x;
                            act_y = _y;
                            
                            break;
                        }
                    }
                    
                    this.grid.setCell(this.x, this.y, 0);
                    
                    this.prev_x = this.x;
                    this.prev_y = this.y;
                    this.x = act_x;
                    this.y = act_y;
                    
                    this.grid.setCell(this.x, this.y, 1);
                };
                
                var scheduler = new jssim.Scheduler();
                
                var grid = new jssim.Grid(128, 128);
                grid.cellWidth = 5;
                grid.cellHeight = 5;
                

                function reset() {
                    scheduler.reset(); 
                    grid.reset();
                    
                    grid.createCylinder(50, 80, 20);
                    grid.createCylinder(30, 100, 20);
                    grid.createCylinder(80, 50, 20);
                    
                    grid.createTarget(100, 100, 4);
                    
                    for(var i = 0; i < 30; ++i) {
                        var ant = new Ant(i, grid, 10, 10);
                        scheduler.scheduleRepeatingIn(ant, 1);
                    }
                }
                
                reset();
                
                var canvas = document.getElementById("myCanvas");
                
                setInterval(function(){ 
                    if(scheduler.current_time == 10000) {
                        reset();
                    }
                    scheduler.update();
                    grid.render(canvas);
                    console.log('current simulation time: ' + scheduler.current_time);
                    document.getElementById("simTime").value = "Simulation Time: " + scheduler.current_time;
                }, 1000);
            })();
        </script>
    </body>
</html>