<html>
    <head>
        <title>Discrete-Event Simulator: Ant Foraging</title>
        <script src="../src/jssim.js" type="text/javascript"></script>
    </head>
    <body>
        <h2>Discrete-Event Simulator: Ant Foraging <input type="text" id="simTime" value="" /></h2>
        
        <canvas id="myCanvas" width="640" height="640" style="border:1px solid #000000;">
        </canvas>
        
        <script>
            (function(){
                
                var Ant = function(id, grid, pheromones, x, y) {
                    jssim.SimEvent(this);
                    this.id = id;
                    this.x = x;
                    this.y = y;
                    this.init_x = x;
                    this.init_y = y;
                    this.prev_x = x;
                    this.prev_y = y;
                    this.grid = grid;
                    this.pheromones = pheromones;
                    this.target_x = 0;
                    this.target_y = 0;
                    this.grid.setCell(this.x, this.y, 1);
                };
                
                Ant.prototype.update = function(deltaTime) {
                    var act_x = this.x;
                    var act_y = this.y;
                    
                    var candidates = [];
                    
                    for(var dx = -1; dx <= 1; ++dx) {
                        for(var dy = -1; dy <= 1; ++dy) {
                            var _x = this.x + dx;
                            var _y = this.y + dy;
                            if(_x == this.prev_x && _y == this.prev_y) continue;
                            if(_x == this.x && _y == this.y) continue;
                            if(!this.grid.hasPath(_x, _y)) {
                                continue;
                            }
                            /*if(this.grid.isOccupied(_x, _y)) {
                                continue;
                            }*/
                            if(this.grid.isTarget(_x, _y)) {
                                this.grid.setCell(this.x, this.y, 0);
                                this.x = this.init_x;
                                this.y = this.init_y;
                                this.prev_x = this.x;
                                this.prev_y = this.y;
                                this.grid.setCell(this.x, this.y, 1);
                                console.log(this.id + ' reach target!');
                                return;
                            }
                            
                            candidates.push({
                                x: _x,
                                y: _y
                            });
                            
                            break;
                        }
                    }
                    
                    var heuristic = [];
                    var heuristic_sum = 0;
                    var max_i = -1;
                    var max_heuristic_b = 0;
                    var dx2 = this.target_x - this.x;
                    var dy2 = this.target_y - this.y;
                    var dlen = dx2 * dx2 + dy2 * dy2;
                    for(var i = 0; i < candidates.length; ++i) {
                        var move = candidates[i];
                        var dx = move.x - this.x;
                        var dy = move.y - this.y;
                        var distance = dx * dx2 + dy * dy2;
                        var heuristic_b = dlen + distance;
                        heuristic_sum += heuristic_b;
                        heuristic.push(heuristic_b);
                        if(heuristic_b > max_heuristic_b) {
                            max_heuristic_b = heuristic_b;
                            max_i = i;
                        }
                    }
                    
                    for(var i = 0; i < candidates.length; ++i) {
                        var prev_h = 0;
                        if(i > 0) prev_h = heuristic[i-1];
                        heuristic[i] += prev_h;
                    }
                    
                    for(var i = 0; i < candidates.length; ++i) {
                        heuristic[i] /= heuristic_sum;
                    }
                    
                    /*
                    var r = Math.random();
                    
                    for(var i = 0; i < candidates.length; ++i) {
                        if(r <= heuristic[i]) {
                            act_x = candidates[i].x;
                            act_y = candidates[i].y;
                            break;
                        }
                    }*/
                    
                    max_i = Math.floor(Math.random() * candidates.length);
                    
                    
                    if(max_i != -1){
                        act_x = candidates[max_i].x;
                        act_y = candidates[max_i].y;
                    }
                    
                    this.grid.setCell(this.x, this.y, 0);
                    
                    this.prev_x = this.x;
                    this.prev_y = this.y;
                    this.x = act_x;
                    this.y = act_y;
                    
                    this.grid.setCell(this.x, this.y, 1);
                };
                
                var scheduler = new jssim.Scheduler();
                
                var grid = new jssim.Grid(128, 128);
                grid.cellWidth = 5;
                grid.cellHeight = 5;
                grid.showTrails = true;
                
                var pheromones = new jssim.Grid(128, 128);
                pheromones.cellWidth = 5;
                pheromones.cellHeight = 5;
                

                function reset() {
                    scheduler.reset(); 
                    grid.reset();
                    pheromones.reset();
                    
                    grid.createCylinder(50, 80, 20);
                    grid.createCylinder(30, 100, 20);
                    grid.createCylinder(80, 50, 20);
                    
                    for(var x= 0; x < 128; ++x){
                        for(var y = 0; y <128; ++y) {
                            pheromones.setCell(x, y, 1.0 / (128 * 128));
                        }
                    }
                    
                    grid.createTarget(100, 100, 4);
                    
                    for(var i = 0; i < 30; ++i) {
                        var ant = new Ant(i, grid, pheromones, 10, 10);
                        ant.target_x = 100;
                        ant.target_y = 100;
                        scheduler.scheduleRepeatingIn(ant, 1);
                    }
                }
                
                reset();
                
                var canvas = document.getElementById("myCanvas");
                
                setInterval(function(){ 
                    if(scheduler.current_time == 10000) {
                        reset();
                    }
                    scheduler.update();
                    grid.render(canvas);
                    console.log('current simulation time: ' + scheduler.current_time);
                    document.getElementById("simTime").value = "Simulation Time: " + scheduler.current_time;
                }, 50);
            })();
        </script>
    </body>
</html>